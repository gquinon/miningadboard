<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>üîç Diagn√≥stico de Datos</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
        }
        h2 {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9em;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
        }
        .btn:hover { background: #5568d3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .actions { text-align: center; margin: 20px 0; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        .metric-label {
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üîç Diagn√≥stico Completo de Datos</h1>
            <p style="text-align: center; color: #666;">Verificaci√≥n de todas las fuentes de datos del sistema</p>
            
            <div class="actions">
                <button class="btn" onclick="diagnosticar()">üîç Ejecutar Diagn√≥stico</button>
                <button class="btn btn-success" onclick="cargarDesdeJSON()">üìÑ Cargar desde proyectos.json</button>
                <button class="btn btn-success" onclick="window.location.href='Panel-Admin-Nuevo.html'">üìä Ir al Panel Admin</button>
            </div>
            
            <div id="results"></div>
        </div>
    </div>

    <!-- Cargar scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="config.js"></script>
    <script src="firebase-manager-universal.js"></script>
    <script src="database-manager-simple.js"></script>

    <script>
        async function diagnosticar() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="status info">‚è≥ Ejecutando diagn√≥stico...</div>';
            
            let html = '';
            
            // 1. Verificar proyectos.json
            html += '<h2>üìÑ proyectos.json</h2>';
            try {
                const response = await fetch('proyectos.json');
                const data = await response.json();
                
                if (data && data.data && data.data.length > 0) {
                    html += '<div class="status success">‚úÖ proyectos.json cargado correctamente</div>';
                    html += '<div class="grid">';
                    html += `<div class="metric"><div class="metric-value">${data.data.length}</div><div class="metric-label">Proyectos</div></div>`;
                    html += `<div class="metric"><div class="metric-value">${data.columns.length}</div><div class="metric-label">Columnas</div></div>`;
                    html += '</div>';
                    
                    // Mostrar primer proyecto
                    html += '<h3>Primer proyecto de ejemplo:</h3>';
                    html += '<pre>' + JSON.stringify(data.data[0], null, 2) + '</pre>';
                    
                    // Verificar formato de campos
                    const firstProject = data.data[0];
                    const hasSpaces = 'Nombre del proyecto' in firstProject;
                    const hasUnderscores = 'Nombre_del_proyecto' in firstProject;
                    
                    if (hasSpaces) {
                        html += '<div class="status success">‚úÖ Formato correcto: campos con espacios</div>';
                    } else if (hasUnderscores) {
                        html += '<div class="status warning">‚ö†Ô∏è Formato con guiones bajos (se soporta pero no es ideal)</div>';
                    }
                } else {
                    html += '<div class="status error">‚ùå proyectos.json est√° vac√≠o</div>';
                }
            } catch (error) {
                html += '<div class="status error">‚ùå Error cargando proyectos.json: ' + error.message + '</div>';
            }
            
            // 2. Verificar Firebase
            html += '<h2>üî• Firebase</h2>';
            if (window.firebaseManager) {
                try {
                    const firebaseData = await window.firebaseManager.getAllData();
                    
                    if (firebaseData && firebaseData.data && firebaseData.data.length > 0) {
                        html += '<div class="status success">‚úÖ Firebase tiene datos</div>';
                        html += '<div class="grid">';
                        html += `<div class="metric"><div class="metric-value">${firebaseData.data.length}</div><div class="metric-label">Proyectos en Firebase</div></div>`;
                        html += '</div>';
                        
                        // Verificar formato
                        const firstProject = firebaseData.data[0];
                        const hasSpaces = 'Nombre del proyecto' in firstProject || 'Nombre_del_proyecto' in firstProject;
                        
                        html += '<h3>Primer proyecto en Firebase:</h3>';
                        html += '<pre>' + JSON.stringify(firstProject, null, 2).substring(0, 500) + '...</pre>';
                    } else {
                        html += '<div class="status warning">‚ö†Ô∏è Firebase est√° vac√≠o</div>';
                    }
                } catch (error) {
                    html += '<div class="status error">‚ùå Error accediendo a Firebase: ' + error.message + '</div>';
                }
            } else {
                html += '<div class="status error">‚ùå Firebase Manager no disponible</div>';
            }
            
            // 3. Verificar Database Manager
            html += '<h2>üíæ Database Manager</h2>';
            if (window.dbManager) {
                await new Promise(resolve => setTimeout(resolve, 2000)); // Esperar a que cargue
                
                const dbData = window.dbManager.getAllData();
                
                if (dbData && dbData.data && dbData.data.length > 0) {
                    html += '<div class="status success">‚úÖ Database Manager tiene datos</div>';
                    html += '<div class="grid">';
                    html += `<div class="metric"><div class="metric-value">${dbData.data.length}</div><div class="metric-label">Proyectos en memoria</div></div>`;
                    html += `<div class="metric"><div class="metric-value">${dbData.metadata.source}</div><div class="metric-label">Fuente</div></div>`;
                    html += '</div>';
                    
                    // Calcular estad√≠sticas
                    const stats = window.dbManager.getStats();
                    html += '<div class="grid">';
                    html += `<div class="metric"><div class="metric-value">$${stats.totalCapex.toLocaleString()}</div><div class="metric-label">CAPEX Total (MM)</div></div>`;
                    html += `<div class="metric"><div class="metric-value">${Object.keys(stats.sectors).length}</div><div class="metric-label">Sectores</div></div>`;
                    html += `<div class="metric"><div class="metric-value">${Object.keys(stats.countries).length}</div><div class="metric-label">Pa√≠ses</div></div>`;
                    html += '</div>';
                    
                    html += '<h3>Primer proyecto en Database Manager:</h3>';
                    html += '<pre>' + JSON.stringify(dbData.data[0], null, 2) + '</pre>';
                } else {
                    html += '<div class="status warning">‚ö†Ô∏è Database Manager est√° vac√≠o</div>';
                    html += '<p>Haz clic en "Cargar desde proyectos.json" para cargar datos.</p>';
                }
            } else {
                html += '<div class="status error">‚ùå Database Manager no disponible</div>';
            }
            
            // 4. Verificar localStorage (aunque ya no lo usamos)
            html += '<h2>üíø localStorage (legacy)</h2>';
            const localData = localStorage.getItem('minero_database');
            if (localData) {
                try {
                    const parsed = JSON.parse(localData);
                    html += '<div class="status warning">‚ö†Ô∏è localStorage tiene datos antiguos (ya no se usa)</div>';
                    html += `<p>Proyectos en localStorage: ${parsed.data ? parsed.data.length : 0}</p>`;
                    html += '<button class="btn" onclick="localStorage.removeItem(\'minero_database\'); diagnosticar();">üóëÔ∏è Limpiar localStorage</button>';
                } catch (error) {
                    html += '<div class="status error">‚ùå localStorage tiene datos corruptos</div>';
                }
            } else {
                html += '<div class="status success">‚úÖ localStorage limpio (correcto)</div>';
            }
            
            resultsDiv.innerHTML = html;
        }
        
        async function cargarDesdeJSON() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="status info">‚è≥ Cargando datos desde proyectos.json...</div>';
            
            try {
                const response = await fetch('proyectos.json');
                const data = await response.json();
                
                if (!data || !data.data || data.data.length === 0) {
                    throw new Error('proyectos.json est√° vac√≠o');
                }
                
                // Actualizar Database Manager
                window.dbManager.data = {
                    columns: data.columns,
                    data: data.data,
                    metadata: {
                        source: 'proyectos.json',
                        lastUpdate: new Date().toISOString(),
                        totalRecords: data.data.length,
                        version: '2.0.0'
                    }
                };
                
                // Guardar en Firebase
                await window.dbManager.saveDatabase();
                
                resultsDiv.innerHTML = '<div class="status success">‚úÖ Datos cargados exitosamente: ' + data.data.length + ' proyectos</div>';
                
                setTimeout(() => {
                    diagnosticar();
                }, 1000);
                
            } catch (error) {
                resultsDiv.innerHTML = '<div class="status error">‚ùå Error: ' + error.message + '</div>';
            }
        }
        
        // Ejecutar diagn√≥stico al cargar
        window.addEventListener('load', () => {
            setTimeout(diagnosticar, 2000);
        });
    </script>
</body>
</html>
