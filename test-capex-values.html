<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>üß™ Test Valores CAPEX</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
        }
        .card {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #0f3460;
        }
        .success { border-left-color: #2ecc71; }
        .error { border-left-color: #e74c3c; }
        .warning { border-left-color: #f39c12; }
        pre {
            background: #0f0f23;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        h1 { color: #58b5ff; }
        h2 { color: #4a9fd8; margin-top: 30px; }
        .btn {
            background: #58b5ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .btn:hover { background: #4a9fd8; }
    </style>
</head>
<body>
    <h1>üß™ Test de Valores CAPEX</h1>
    <button class="btn" onclick="testCapex()">üîç Probar Lectura de CAPEX</button>
    <div id="results"></div>

    <script src="firebase-manager-universal.js"></script>
    <script src="database-manager-simple.js"></script>
    
    <script>
        // Helper para CAPEX
        function getCapexValue(project) {
            if (!project) return 0;
            
            const capexFormats = [
                'Capex (US$ mn)',
                'Capex_US_mn',
                'Capex_US$_mn',
                'CapexUSmn',
                'CAPEX',
                'Capex'
            ];
            
            for (const format of capexFormats) {
                if (project[format] !== undefined && project[format] !== null && project[format] !== '') {
                    const value = parseFloat(project[format]);
                    if (!isNaN(value)) {
                        console.log(`‚úÖ CAPEX encontrado en campo "${format}": ${value}`);
                        return value;
                    }
                }
            }
            
            console.warn('‚ö†Ô∏è No se encontr√≥ CAPEX en ning√∫n formato');
            return 0;
        }
        
        async function testCapex() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="card">‚è≥ Cargando datos...</div>';
            
            // Esperar a que dbManager cargue
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            let html = '';
            
            // Test 1: Verificar datos en dbManager
            html += '<h2>üìä Datos en Database Manager</h2>';
            if (window.dbManager) {
                const data = window.dbManager.getAllData();
                html += `<div class="card success">‚úÖ ${data.data.length} proyectos cargados</div>`;
                
                // Mostrar primeros 5 proyectos con sus valores CAPEX
                html += '<h2>üîç Primeros 5 Proyectos y sus CAPEX</h2>';
                
                for (let i = 0; i < Math.min(5, data.data.length); i++) {
                    const project = data.data[i];
                    const capex = getCapexValue(project);
                    
                    // Mostrar todos los campos del proyecto
                    const fields = Object.keys(project);
                    const capexFields = fields.filter(f => f.toLowerCase().includes('capex'));
                    
                    html += `<div class="card ${capex > 0 ? 'success' : 'error'}">`;
                    html += `<h3>Proyecto ${i + 1}</h3>`;
                    html += `<p><strong>Nombre:</strong> ${project['Nombre del proyecto'] || project['Nombre_del_proyecto'] || 'Sin nombre'}</p>`;
                    html += `<p><strong>CAPEX Calculado:</strong> $${capex.toLocaleString()} MM</p>`;
                    html += `<p><strong>Campos CAPEX encontrados:</strong></p>`;
                    html += '<pre>' + JSON.stringify(capexFields, null, 2) + '</pre>';
                    
                    if (capexFields.length > 0) {
                        html += '<p><strong>Valores de campos CAPEX:</strong></p>';
                        html += '<pre>';
                        capexFields.forEach(field => {
                            html += `${field}: ${project[field]}\n`;
                        });
                        html += '</pre>';
                    }
                    
                    html += '</div>';
                }
                
                // Estad√≠sticas
                html += '<h2>üìà Estad√≠sticas</h2>';
                const stats = window.dbManager.getStats();
                html += `<div class="card">`;
                html += `<p><strong>Total Proyectos:</strong> ${stats.totalProjects}</p>`;
                html += `<p><strong>CAPEX Total:</strong> $${stats.totalCapex.toLocaleString()} MM</p>`;
                html += `<p><strong>CAPEX Promedio:</strong> $${(stats.totalCapex / stats.totalProjects).toLocaleString()} MM</p>`;
                html += `</div>`;
                
            } else {
                html += '<div class="card error">‚ùå Database Manager no disponible</div>';
            }
            
            resultsDiv.innerHTML = html;
        }
        
        // Auto-ejecutar despu√©s de cargar
        window.addEventListener('load', () => {
            setTimeout(testCapex, 3000);
        });
    </script>
</body>
</html>
