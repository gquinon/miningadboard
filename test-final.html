<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>‚úÖ Test Final del Sistema</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .test-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .summary {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .summary h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .score {
            font-size: 4em;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .score.perfect {
            color: #28a745;
        }
        
        .score.good {
            color: #ffc107;
        }
        
        .score.bad {
            color: #dc3545;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .actions {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úÖ Test Final del Sistema</h1>
            <p>Verificaci√≥n completa de todos los componentes</p>
        </div>
        
        <div class="summary" id="summary">
            <h2>Ejecutando pruebas...</h2>
            <div class="status loading">‚è≥ Por favor espera...</div>
        </div>
        
        <div class="test-grid" id="test-grid"></div>
        
        <div class="actions" id="actions" style="text-align: center; display: none;">
            <a href="Panel-Admin-Nuevo.html" class="btn btn-success">üöÄ Ir al Panel de Administraci√≥n</a>
            <a href="Dashboard Ejecutivo - Proyectos Mineros.html" class="btn">üìà Ir al Dashboard</a>
        </div>
    </div>

    <!-- Cargar scripts en orden -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="config.js?v=<?php echo time(); ?>"></script>
    <script src="firebase-manager-universal.js?v=<?php echo time(); ?>"></script>
    <script src="database-manager.js?v=<?php echo time(); ?>"></script>
    <script src="mass-operations.js?v=<?php echo time(); ?>"></script>

    <script>
        const tests = [
            {
                name: 'üìö Librer√≠a XLSX',
                icon: 'üìö',
                test: () => {
                    const success = typeof XLSX !== 'undefined';
                    return {
                        success,
                        details: success ? `Versi√≥n: ${XLSX.version}` : 'No disponible'
                    };
                }
            },
            {
                name: '‚öôÔ∏è DashboardConfig',
                icon: '‚öôÔ∏è',
                test: () => {
                    const success = typeof window.DashboardConfig !== 'undefined';
                    return {
                        success,
                        details: success ? `App: ${window.DashboardConfig.app.name} v${window.DashboardConfig.app.version}` : 'No disponible'
                    };
                }
            },
            {
                name: 'üî• Firebase Config',
                icon: 'üî•',
                test: () => {
                    const hasConfig = window.DashboardConfig?.firebaseConfig || window.firebaseConfig;
                    const config = window.DashboardConfig?.firebaseConfig || window.firebaseConfig;
                    return {
                        success: !!hasConfig,
                        details: hasConfig ? `ProjectId: ${config.projectId}\nDatabaseURL: ${config.databaseURL ? '‚úÖ' : '‚ùå'}` : 'No disponible'
                    };
                }
            },
            {
                name: 'üíæ Database Manager',
                icon: 'üíæ',
                test: () => {
                    const success = typeof window.dbManager !== 'undefined';
                    let details = 'No disponible';
                    if (success) {
                        const data = window.dbManager.getAllData();
                        details = `Proyectos: ${data?.data?.length || 0}\nColumnas: ${data?.columns?.length || 0}`;
                    }
                    return { success, details };
                }
            },
            {
                name: 'üåê Firebase Manager',
                icon: 'üåê',
                test: () => {
                    const success = typeof window.firebaseManager !== 'undefined';
                    return {
                        success,
                        details: success ? `BaseURL: ${window.firebaseManager.baseURL || 'N/A'}` : 'No disponible'
                    };
                }
            },
            {
                name: '‚ö° Mass Operations',
                icon: '‚ö°',
                test: () => {
                    const hasLoad = typeof massLoadFromExcel !== 'undefined' || typeof cargarDatosDesdeExcel !== 'undefined';
                    const hasDelete = typeof borrarTodosLosDatos !== 'undefined';
                    return {
                        success: hasLoad,
                        details: `Carga masiva: ${hasLoad ? '‚úÖ' : '‚ùå'}\nBorrado masivo: ${hasDelete ? '‚úÖ' : '‚ùå'}`
                    };
                }
            },
            {
                name: 'üíø LocalStorage',
                icon: 'üíø',
                test: () => {
                    try {
                        const testKey = 'test_' + Date.now();
                        localStorage.setItem(testKey, 'test');
                        localStorage.removeItem(testKey);
                        
                        const mineroData = localStorage.getItem('minero_database');
                        let details = 'Funcional';
                        if (mineroData) {
                            const parsed = JSON.parse(mineroData);
                            details = `${parsed.data?.length || 0} proyectos almacenados`;
                        } else {
                            details = 'Vac√≠o (sin datos)';
                        }
                        
                        return { success: true, details };
                    } catch (error) {
                        return { success: false, details: 'Error: ' + error.message };
                    }
                }
            },
            {
                name: 'üìÑ proyectos.json',
                icon: 'üìÑ',
                test: async () => {
                    try {
                        const response = await fetch('proyectos.json');
                        const data = await response.json();
                        return {
                            success: response.ok && data.data && data.data.length > 0,
                            details: `${data.data?.length || 0} proyectos\n${data.columns?.length || 0} columnas`
                        };
                    } catch (error) {
                        return { success: false, details: 'Error: ' + error.message };
                    }
                }
            }
        ];

        async function runTests() {
            const grid = document.getElementById('test-grid');
            const summaryDiv = document.getElementById('summary');
            const actionsDiv = document.getElementById('actions');
            
            grid.innerHTML = '';
            let passed = 0;
            let total = tests.length;
            
            for (const test of tests) {
                const card = document.createElement('div');
                card.className = 'test-card';
                card.innerHTML = `
                    <h3>${test.icon} ${test.name}</h3>
                    <div class="status loading">‚è≥ Ejecutando...</div>
                    <div class="details" style="display: none;"></div>
                `;
                grid.appendChild(card);
                
                // Ejecutar test
                const result = await test.test();
                
                // Actualizar card
                const statusDiv = card.querySelector('.status');
                const detailsDiv = card.querySelector('.details');
                
                statusDiv.className = 'status ' + (result.success ? 'success' : 'error');
                statusDiv.textContent = result.success ? '‚úÖ OK' : '‚ùå Error';
                
                detailsDiv.style.display = 'block';
                detailsDiv.textContent = result.details;
                
                if (result.success) passed++;
            }
            
            // Mostrar resumen
            const percentage = Math.round((passed / total) * 100);
            let scoreClass = 'bad';
            let message = '‚ö†Ô∏è Hay problemas que resolver';
            
            if (percentage === 100) {
                scoreClass = 'perfect';
                message = 'üéâ ¬°Sistema completamente funcional!';
                actionsDiv.style.display = 'block';
            } else if (percentage >= 75) {
                scoreClass = 'good';
                message = '‚úÖ Sistema mayormente funcional';
                actionsDiv.style.display = 'block';
            }
            
            summaryDiv.innerHTML = `
                <h2>${message}</h2>
                <div class="score ${scoreClass}">${passed}/${total}</div>
                <p>${percentage}% de componentes funcionando</p>
            `;
        }

        // Ejecutar tests cuando todo est√© cargado
        window.addEventListener('load', () => {
            setTimeout(runTests, 2000);
        });
    </script>
</body>
</html>
