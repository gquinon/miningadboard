<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Auditor√≠a Completa del Sistema</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .test-card h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-card .icon {
            font-size: 1.5em;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .status.loading {
            background: #ffd93d;
            color: #333;
        }
        
        .status.success {
            background: #6bcf7f;
            color: white;
        }
        
        .status.error {
            background: #ff6b6b;
            color: white;
        }
        
        .status.warning {
            background: #ffa502;
            color: white;
        }
        
        .test-result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .test-result pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #6bcf7f;
            color: white;
        }
        
        .btn-success:hover {
            background: #5ab86d;
        }
        
        .btn-danger {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ee5a52;
        }
        
        .btn-warning {
            background: #ffa502;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e69500;
        }
        
        .summary {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .summary h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .summary-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .summary-item .number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .summary-item .label {
            color: #666;
            font-size: 1.1em;
        }
        
        .iframe-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 30px;
        }
        
        .iframe-container h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .iframe-container iframe {
            width: 100%;
            height: 800px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }
        
        .page-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading-animation {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Auditor√≠a Completa del Sistema</h1>
            <p>Verificaci√≥n en tiempo real de todos los componentes</p>
        </div>
        
        <div class="summary">
            <h2>üìä Resumen de Pruebas</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="number" id="total-tests" style="color: #667eea;">0</div>
                    <div class="label">Total Pruebas</div>
                </div>
                <div class="summary-item">
                    <div class="number" id="passed-tests" style="color: #6bcf7f;">0</div>
                    <div class="label">Exitosas</div>
                </div>
                <div class="summary-item">
                    <div class="number" id="failed-tests" style="color: #ff6b6b;">0</div>
                    <div class="label">Fallidas</div>
                </div>
                <div class="summary-item">
                    <div class="number" id="warning-tests" style="color: #ffa502;">0</div>
                    <div class="label">Advertencias</div>
                </div>
            </div>
        </div>
        
        <div class="test-grid" id="test-grid"></div>
        
        <div class="iframe-container">
            <h2>üñ•Ô∏è Vista Previa en Vivo</h2>
            <div class="page-selector">
                <button class="btn btn-primary" onclick="loadPage('index.html')">üè† Inicio</button>
                <button class="btn btn-primary" onclick="loadPage('login-profesional.html')">üîê Login</button>
                <button class="btn btn-primary" onclick="loadPage('Panel-Admin-Nuevo.html')">üìä Panel Admin</button>
                <button class="btn btn-primary" onclick="loadPage('Dashboard Ejecutivo - Proyectos Mineros.html')">üìà Dashboard</button>
                <button class="btn btn-primary" onclick="loadPage('diagnostico-panel.html')">üîß Diagn√≥stico</button>
            </div>
            <iframe id="preview-frame" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        const tests = [
            {
                id: 'test-xlsx',
                name: 'Librer√≠a XLSX',
                icon: 'üìö',
                test: async () => {
                    return new Promise((resolve) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                        script.onload = () => {
                            if (typeof XLSX !== 'undefined') {
                                resolve({ success: true, message: 'XLSX cargado correctamente', data: `Versi√≥n: ${XLSX.version}` });
                            } else {
                                resolve({ success: false, message: 'XLSX no disponible despu√©s de cargar' });
                            }
                        };
                        script.onerror = () => resolve({ success: false, message: 'Error al cargar XLSX desde CDN' });
                        document.head.appendChild(script);
                    });
                }
            },
            {
                id: 'test-firebase-config',
                name: 'Configuraci√≥n Firebase',
                icon: 'üî•',
                test: async () => {
                    try {
                        // Primero verificar en config.js
                        const response = await fetch('config.js');
                        const text = await response.text();
                        
                        if (text.includes('firebaseConfig')) {
                            const hasApiKey = text.includes('apiKey');
                            const hasProjectId = text.includes('projectId');
                            const hasAppId = text.includes('appId');
                            const hasDatabaseURL = text.includes('databaseURL');
                            
                            if (hasApiKey && hasProjectId && hasAppId) {
                                return { success: true, message: 'Configuraci√≥n Firebase completa', data: `‚úÖ config.js: apiKey, projectId, appId${hasDatabaseURL ? ', databaseURL' : ''}` };
                            } else {
                                return { success: 'warning', message: 'Configuraci√≥n Firebase incompleta', data: `apiKey: ${hasApiKey}, projectId: ${hasProjectId}, appId: ${hasAppId}` };
                            }
                        }
                        
                        // Verificar en firebase-manager-universal.js
                        const fbResponse = await fetch('firebase-manager-universal.js');
                        const fbText = await fbResponse.text();
                        
                        if (fbText.includes('firebaseConfig') && fbText.includes('apiKey')) {
                            return { success: true, message: 'Configuraci√≥n Firebase en firebase-manager', data: '‚úÖ firebase-manager-universal.js contiene config' };
                        }
                        
                        return { success: false, message: 'No se encontr√≥ firebaseConfig', data: 'Revisar config.js y firebase-manager-universal.js' };
                        
                    } catch (error) {
                        return { success: false, message: 'Error al leer configuraci√≥n', data: error.message };
                    }
                }
            },
            {
                id: 'test-database-manager',
                name: 'Database Manager',
                icon: 'üíæ',
                test: async () => {
                    try {
                        const response = await fetch('database-manager.js');
                        if (response.ok) {
                            const text = await response.text();
                            const hasClass = text.includes('class DatabaseManager');
                            const hasGetAllData = text.includes('getAllData');
                            const hasGetStats = text.includes('getStats');
                            
                            if (hasClass && hasGetAllData && hasGetStats) {
                                return { success: true, message: 'DatabaseManager completo', data: 'Todas las funciones principales presentes' };
                            } else {
                                return { success: 'warning', message: 'DatabaseManager incompleto', data: `class: ${hasClass}, getAllData: ${hasGetAllData}, getStats: ${hasGetStats}` };
                            }
                        } else {
                            return { success: false, message: 'No se pudo cargar database-manager.js' };
                        }
                    } catch (error) {
                        return { success: false, message: 'Error al verificar DatabaseManager', data: error.message };
                    }
                }
            },
            {
                id: 'test-firebase-manager',
                name: 'Firebase Manager Universal',
                icon: 'üåê',
                test: async () => {
                    try {
                        const response = await fetch('firebase-manager-universal.js');
                        if (response.ok) {
                            const text = await response.text();
                            const hasClass = text.includes('class FirebaseManager');
                            const hasGetAllData = text.includes('getAllData');
                            const hasSaveData = text.includes('saveData');
                            
                            if (hasClass && hasGetAllData && hasSaveData) {
                                return { success: true, message: 'FirebaseManager universal completo', data: 'Funciones de lectura/escritura presentes' };
                            } else {
                                return { success: 'warning', message: 'FirebaseManager incompleto', data: `class: ${hasClass}, getAllData: ${hasGetAllData}, saveData: ${hasSaveData}` };
                            }
                        } else {
                            return { success: false, message: 'No se encontr√≥ firebase-manager-universal.js' };
                        }
                    } catch (error) {
                        return { success: false, message: 'Error al verificar FirebaseManager', data: error.message };
                    }
                }
            },
            {
                id: 'test-mass-operations',
                name: 'Operaciones Masivas',
                icon: '‚ö°',
                test: async () => {
                    try {
                        const response = await fetch('mass-operations.js');
                        if (response.ok) {
                            const text = await response.text();
                            const hasMassLoad = text.includes('massLoadFromExcel') || text.includes('cargarDatosDesdeExcel');
                            const hasMassDelete = text.includes('massDelete') || text.includes('borrarTodosLosDatos');
                            
                            if (hasMassLoad && hasMassDelete) {
                                return { success: true, message: 'Operaciones masivas disponibles', data: 'Carga y borrado masivo implementados' };
                            } else {
                                return { success: 'warning', message: 'Operaciones masivas incompletas', data: `Carga: ${hasMassLoad}, Borrado: ${hasMassDelete}` };
                            }
                        } else {
                            return { success: false, message: 'No se encontr√≥ mass-operations.js' };
                        }
                    } catch (error) {
                        return { success: false, message: 'Error al verificar operaciones masivas', data: error.message };
                    }
                }
            },
            {
                id: 'test-panel-admin',
                name: 'Panel de Administraci√≥n',
                icon: 'üìä',
                test: async () => {
                    try {
                        const response = await fetch('Panel-Admin-Nuevo.html');
                        if (response.ok) {
                            const text = await response.text();
                            const hasInitPanel = text.includes('initializePanel');
                            const hasLoadDefaultData = text.includes('loadDefaultData');
                            const hasUpdateStats = text.includes('updateStats');
                            const hasLoadTable = text.includes('loadProjectsTable');
                            
                            if (hasInitPanel && hasLoadDefaultData && hasUpdateStats && hasLoadTable) {
                                return { success: true, message: 'Panel Admin con todas las funciones', data: 'Inicializaci√≥n robusta implementada' };
                            } else {
                                return { success: 'warning', message: 'Panel Admin incompleto', data: `init: ${hasInitPanel}, default: ${hasLoadDefaultData}, stats: ${hasUpdateStats}, table: ${hasLoadTable}` };
                            }
                        } else {
                            return { success: false, message: 'No se encontr√≥ Panel-Admin-Nuevo.html' };
                        }
                    } catch (error) {
                        return { success: false, message: 'Error al verificar Panel Admin', data: error.message };
                    }
                }
            },
            {
                id: 'test-dashboard',
                name: 'Dashboard Ejecutivo',
                icon: 'üìà',
                test: async () => {
                    try {
                        const response = await fetch('Dashboard Ejecutivo - Proyectos Mineros.html');
                        if (response.ok) {
                            const text = await response.text();
                            const hasLeaflet = text.includes('leaflet');
                            const hasChartJS = text.includes('chart.js');
                            const hasInitMap = text.includes('initMap') || text.includes('map');
                            
                            if (hasLeaflet && hasChartJS && hasInitMap) {
                                return { success: true, message: 'Dashboard con mapas y gr√°ficos', data: 'Leaflet y Chart.js configurados' };
                            } else {
                                return { success: 'warning', message: 'Dashboard incompleto', data: `Leaflet: ${hasLeaflet}, ChartJS: ${hasChartJS}, Map: ${hasInitMap}` };
                            }
                        } else {
                            return { success: false, message: 'No se encontr√≥ Dashboard Ejecutivo' };
                        }
                    } catch (error) {
                        return { success: false, message: 'Error al verificar Dashboard', data: error.message };
                    }
                }
            },
            {
                id: 'test-auth-system',
                name: 'Sistema de Autenticaci√≥n',
                icon: 'üîê',
                test: async () => {
                    try {
                        const response = await fetch('auth-system-pro.js');
                        if (response.ok) {
                            const text = await response.text();
                            const hasLogin = text.includes('login');
                            const hasLogout = text.includes('logout');
                            const hasCheckAuth = text.includes('checkAuth') || text.includes('isAuthenticated');
                            
                            if (hasLogin && hasLogout && hasCheckAuth) {
                                return { success: true, message: 'Sistema de autenticaci√≥n completo', data: 'Login, logout y verificaci√≥n implementados' };
                            } else {
                                return { success: 'warning', message: 'Sistema de auth incompleto', data: `Login: ${hasLogin}, Logout: ${hasLogout}, Check: ${hasCheckAuth}` };
                            }
                        } else {
                            return { success: false, message: 'No se encontr√≥ auth-system-pro.js' };
                        }
                    } catch (error) {
                        return { success: false, message: 'Error al verificar sistema de auth', data: error.message };
                    }
                }
            },
            {
                id: 'test-local-storage',
                name: 'LocalStorage',
                icon: 'üíø',
                test: async () => {
                    try {
                        // Verificar si localStorage est√° disponible
                        if (typeof localStorage === 'undefined') {
                            return { success: false, message: 'localStorage no disponible' };
                        }
                        
                        // Intentar escribir y leer
                        const testKey = 'test_audit_' + Date.now();
                        localStorage.setItem(testKey, 'test');
                        const value = localStorage.getItem(testKey);
                        localStorage.removeItem(testKey);
                        
                        if (value === 'test') {
                            // Verificar datos existentes
                            const mineroData = localStorage.getItem('minero_database');
                            if (mineroData) {
                                const parsed = JSON.parse(mineroData);
                                const projectCount = parsed.data ? parsed.data.length : 0;
                                return { success: true, message: 'localStorage funcionando', data: `${projectCount} proyectos almacenados` };
                            } else {
                                return { success: 'warning', message: 'localStorage vac√≠o', data: 'No hay datos de proyectos' };
                            }
                        } else {
                            return { success: false, message: 'localStorage no funciona correctamente' };
                        }
                    } catch (error) {
                        return { success: false, message: 'Error con localStorage', data: error.message };
                    }
                }
            },
            {
                id: 'test-proyectos-json',
                name: 'Archivo proyectos.json',
                icon: 'üìÑ',
                test: async () => {
                    try {
                        const response = await fetch('proyectos.json');
                        if (response.ok) {
                            const data = await response.json();
                            const projectCount = data.data ? data.data.length : 0;
                            const hasColumns = data.columns && data.columns.length > 0;
                            
                            if (projectCount > 0 && hasColumns) {
                                return { success: true, message: 'proyectos.json v√°lido', data: `${projectCount} proyectos, ${data.columns.length} columnas` };
                            } else {
                                return { success: 'warning', message: 'proyectos.json vac√≠o o incompleto', data: `Proyectos: ${projectCount}, Columnas: ${hasColumns}` };
                            }
                        } else {
                            return { success: false, message: 'No se encontr√≥ proyectos.json' };
                        }
                    } catch (error) {
                        return { success: false, message: 'Error al leer proyectos.json', data: error.message };
                    }
                }
            }
        ];

        let totalTests = 0;
        let passedTests = 0;
        let failedTests = 0;
        let warningTests = 0;

        async function runAllTests() {
            const grid = document.getElementById('test-grid');
            grid.innerHTML = '';
            
            totalTests = tests.length;
            passedTests = 0;
            failedTests = 0;
            warningTests = 0;
            
            updateSummary();
            
            for (const test of tests) {
                const card = createTestCard(test);
                grid.appendChild(card);
                
                // Ejecutar test
                const result = await test.test();
                updateTestCard(test.id, result);
                
                // Actualizar contadores
                if (result.success === true) {
                    passedTests++;
                } else if (result.success === 'warning') {
                    warningTests++;
                } else {
                    failedTests++;
                }
                
                updateSummary();
            }
        }

        function createTestCard(test) {
            const card = document.createElement('div');
            card.className = 'test-card';
            card.id = `card-${test.id}`;
            card.innerHTML = `
                <h3>
                    <span class="icon">${test.icon}</span>
                    ${test.name}
                </h3>
                <div class="status loading loading-animation">‚è≥ Ejecutando...</div>
                <div class="test-result" id="result-${test.id}" style="display: none;"></div>
            `;
            return card;
        }

        function updateTestCard(testId, result) {
            const card = document.getElementById(`card-${testId}`);
            const statusDiv = card.querySelector('.status');
            const resultDiv = document.getElementById(`result-${testId}`);
            
            statusDiv.classList.remove('loading', 'loading-animation');
            
            if (result.success === true) {
                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ ' + result.message;
            } else if (result.success === 'warning') {
                statusDiv.className = 'status warning';
                statusDiv.textContent = '‚ö†Ô∏è ' + result.message;
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå ' + result.message;
            }
            
            if (result.data) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<pre>${result.data}</pre>`;
            }
        }

        function updateSummary() {
            document.getElementById('total-tests').textContent = totalTests;
            document.getElementById('passed-tests').textContent = passedTests;
            document.getElementById('failed-tests').textContent = failedTests;
            document.getElementById('warning-tests').textContent = warningTests;
        }

        function loadPage(page) {
            const iframe = document.getElementById('preview-frame');
            iframe.src = page;
        }

        // Ejecutar tests al cargar
        window.addEventListener('load', () => {
            runAllTests();
        });
    </script>
</body>
</html>
